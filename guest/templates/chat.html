{% extends "base.html" %}
{% block title %}Messages{% endblock %}
{% block head %}
<style>
    .content { display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 6px; -webkit-overflow-scrolling: touch; }
    .msg { max-width: 78%; padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; word-wrap: break-word; }
    .msg.guest { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg.staff { background: #e4e6eb; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
    .msg .time { font-size: 11px; opacity: 0.6; margin-top: 4px; }
    #input-bar { display: flex; align-items: center; padding: 8px 12px; background: white; border-top: 1px solid #ddd; gap: 8px; }
    #input-bar input { flex: 1; padding: 10px 16px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 16px; }
    #input-bar button { padding: 10px 18px; background: #0084ff; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 16px; white-space: nowrap; }
</style>
{% endblock %}
{% block content %}
    <div id="messages"></div>
    <div id="input-bar">
        <input type="text" id="msg" placeholder="Type a message..." autocomplete="off">
        <button onclick="send()">Send</button>
    </div>
    <script>
        const resId = "{{ reservation_id }}";
        const messagesDiv = document.getElementById("messages");
        const msgInput = document.getElementById("msg");

        function loadMessages() {
            return fetch(`/guest/${resId}/messages`)
                .then(r => r.json())
                .then(msgs => {
                    const atBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight < 50;
                    messagesDiv.innerHTML = "";
                    msgs.forEach(m => {
                        const div = document.createElement("div");
                        div.className = "msg " + m.sender;
                        div.innerHTML = m.message + `<div class="time">${m.created_at}</div>`;
                        messagesDiv.appendChild(div);
                    });
                    if (atBottom) messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
        }

        function send() {
            const text = msgInput.value.trim();
            if (!text) return;
            fetch(`/guest/${resId}/messages`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: text})
            }).then(() => {
                msgInput.value = "";
                loadMessages().then(() => { messagesDiv.scrollTop = messagesDiv.scrollHeight; });
            });
        }

        msgInput.addEventListener("keydown", e => { if (e.key === "Enter") send(); });
        loadMessages();
        setInterval(loadMessages, 3000);
    </script>
{% endblock %}
